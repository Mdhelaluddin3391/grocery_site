{% extends 'dashboard/base_dashboard.html' %}

{% block page_title %}Order Details{% endblock page_title %}

{% block content %}

{# Success message placeholder #}
{% if messages %}
    {% for message in messages %}
    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6" role="alert">
        <p>{{ message }}</p>
    </div>
    {% endfor %}
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    {# Left Column - Order Items and Summary #}
    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-start mb-4 pb-4 border-b">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Order #{{ order.order_id }}</h2>
                <p class="text-sm text-gray-500">{{ order.created_at|date:"d M, Y, P" }}</p>
            </div>
            <span class="px-3 py-1 text-sm font-semibold rounded-full 
                {% if order.status == 'Pending' %}bg-yellow-100 text-yellow-800
                {% elif order.status == 'Processing' %}bg-blue-100 text-blue-800
                {% elif order.status == 'Packed' %}bg-green-100 text-green-800
                {% elif order.status == 'Dispatched' %}bg-indigo-100 text-indigo-800
                {% elif order.status == 'Delivered' %}bg-purple-100 text-purple-800
                {% else %}bg-red-100 text-red-800{% endif %}">
                {{ order.status }}
            </span>
        </div>

        <h3 class="text-lg font-semibold mb-3">Order Items</h3>
        <div class="divide-y">
            {% for item in order.items.all %}
            <div class="py-3 flex justify-between items-center">
                <div>
                    <p class="font-medium">{{ item.product.name }}</p>
                    <p class="text-sm text-gray-500">Qty: {{ item.quantity }} x ₹{{ item.price|floatformat:2 }}</p>
                </div>
                <p class="font-semibold">₹{{ item.get_subtotal|floatformat:2 }}</p>
            </div>
            {% endfor %}
        </div>
        <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold text-lg">
            <span>Total Amount</span>
            <span>₹{{ order.total_amount|floatformat:2 }}</span>
        </div>
    </div>

    {# Right Column - Customer Details and Actions #}
    <div class="lg:col-span-1 space-y-8">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3">Customer Details</h3>
            <div class="space-y-2 text-sm">
                <p><strong>Name:</strong> {{ order.user.name|default:"N/A" }}</p>
                <p><strong>Phone:</strong> {{ order.user.phone_number|default:"N/A" }}</p>
                <p><strong>Address:</strong><br>
                    {{ order.address.address_line_1 }}<br>
                    {{ order.address.city }}, {{ order.address.state }} - {{ order.address.pincode }}
                </p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3">Picking Status</h3>
            {% if order.picking_job %}
                <p><strong>Assigned to:</strong> {{ order.picking_job.picker.name|default:"Unassigned" }}</p>
                <p><strong>Status:</strong> <span class="font-semibold">{{ order.picking_job.status }}</span></p>
            {% else %}
                 <p class="text-sm text-gray-500">Picking job not created yet.</p>
            {% endif %}
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3">Manual Status Update</h3>
            <form method="post">
                {% csrf_token %}
                <select name="status" class="w-full p-2 border rounded-md mb-4">
                    {% for value, display in status_choices %}
                        <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ display }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">
                    Save Status
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}