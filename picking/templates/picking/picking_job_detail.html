{% extends 'dashboard/base_dashboard.html' %}
{% block page_title %}Picking Order #{{ job.order.order_id }}{% endblock page_title %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div id="completion-message" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6" role="alert">
        <p class="font-bold">All items picked!</p>
        <p>This order has been moved to 'Packed'. Redirecting you to your dashboard...</p>
    </div>
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6 border-b">
            <h3 class="text-xl font-semibold">Items for Order #{{ job.order.order_id }}</h3>
        </div>
        <div id="item-list" class="divide-y">
            {% for item in job.picked_items.all %}
            <div class="p-4 flex justify-between items-center" id="item-row-{{ item.id }}">
                <div>
                    <p class="font-bold">{{ item.order_item.product.name }}</p>
                    <p class="text-sm text-gray-600">Quantity to Pick: <span class="text-lg font-bold">{{ item.order_item.quantity }}</span></p>
                    <p class="text-xs text-gray-500">Barcode: {{ item.order_item.product.barcode|default:"N/A" }}</p>
                </div>
                <div>
                    <button class="pick-btn px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700" data-item-id="{{ item.id }}">
                        Pick Item
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.pick-btn').forEach(button => {
        button.addEventListener('click', async () => {
            const itemId = button.dataset.itemId;
            const url = `/picking/api/pick-item/${itemId}/`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    button.textContent = 'Picked âœ”';
                    button.disabled = true;
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.add('bg-green-600', 'cursor-not-allowed');
                    if (data.all_picked) {
                        document.getElementById('completion-message').classList.remove('hidden');
                        setTimeout(() => {
                            window.location.href = "{% url 'picker_dashboard' %}";
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    });
});
</script>
{% endblock %}