{% extends 'store/base.html' %}
{% load static %}
{% block title %}Customer Login{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'users/css/style.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="auth-container">
    <h2>Customer Login</h2>
    <p class="subtitle">Enter your phone number to continue</p>

    <div id="step-phone">
        <form id="phoneForm" class="auth-form">
            {% csrf_token %}
            <input type="tel" id="phoneInput" name="phone" placeholder="Enter 10-digit phone number" required>
            <button type="submit" class="btn btn-primary">Send OTP</button>
        </form>
    </div>

    <div id="step-otp" style="display:none;">
        <form id="otpForm" class="auth-form">
            {% csrf_token %}
            <input type="hidden" id="otpPhone" name="phone">
            <input type="text" id="otpInput" name="otp" placeholder="Enter 6-digit OTP" required>
            <button type="submit" class="btn btn-secondary">Verify & Login</button>
        </form>
    </div>

    <p id="message"></p>
</div>

<script>
    const phoneForm = document.getElementById('phoneForm');
    const otpForm = document.getElementById('otpForm');
    const msg = document.getElementById('message');
    const stepPhone = document.getElementById('step-phone');
    const stepOtp = document.getElementById('step-otp');
    const otpPhone = document.getElementById('otpPhone');

    phoneForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = document.getElementById('phoneInput').value.trim();
        msg.innerText = 'Sending OTP...';
        msg.style.color = 'var(--text-light)';
        const response = await fetch("{% url 'send_otp' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({phone})
        });
        const data = await response.json();
        if (data.status === 'success') {
            msg.style.color = 'var(--success-color)';
            msg.innerText = data.message;
            otpPhone.value = phone;
            stepPhone.style.display = 'none';
            stepOtp.style.display = 'block';
        } else {
            msg.style.color = 'var(--error-color)';
            msg.innerText = data.message;
        }
    });

    otpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = otpPhone.value;
        const otp = document.getElementById('otpInput').value.trim();
        msg.innerText = 'Verifying OTP...';
        msg.style.color = 'var(--text-light)';
        const response = await fetch("{% url 'verify_otp' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({phone, otp})
        });
        const data = await response.json();
        if (data.status === 'success') {
            msg.style.color = 'var(--success-color)';
            msg.innerText = data.message;
            setTimeout(() => window.location.href = "{% url 'home' %}", 1000);
        } else {
            msg.style.color = 'var(--error-color)';
            msg.innerText = data.message;
        }
    });
</script>
{% endblock %}